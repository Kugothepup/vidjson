<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veo3 Interactive Prompt Builder</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            height: 100vh;
            gap: 0;
        }

        .sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e9ecef;
        }

        .main-scene {
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
        }

        .chat-panel {
            background: white;
            border-left: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .scene-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group select {
            width: 100%;
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px;
            border-radius: 4px;
        }

        .chat-header {
            background: #667eea;
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.4;
        }

        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .ai-message {
            background: white;
            color: #2c3e50;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .send-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .json-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .component-input {
            margin-bottom: 15px;
        }

        .component-input label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .component-input input,
        .component-input textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }

        .component-input textarea {
            height: 60px;
            resize: vertical;
        }

        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .scene-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .lighting-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            min-width: 150px;
        }

        .copy-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Three.js Scene Component
        function SceneViewer({ sceneConfig, onSceneUpdate }) {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const cameraRef = useRef(null);

            useEffect(() => {
                // Scene setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x202020);
                sceneRef.current = scene;

                // Camera setup
                const camera = new THREE.PerspectiveCamera(
                    sceneConfig.camera.fov || 50,
                    mountRef.current.clientWidth / mountRef.current.clientHeight,
                    0.1,
                    1000
                );
                camera.position.set(sceneConfig.camera.x || 0, sceneConfig.camera.y || 5, sceneConfig.camera.z || 10);
                cameraRef.current = camera;

                // Renderer setup
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                rendererRef.current = renderer;
                mountRef.current.appendChild(renderer.domElement);

                // Controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;

                // Ground plane
                const groundGeometry = new THREE.PlaneGeometry(20, 20);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x404040 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                scene.add(ground);

                // Subject placeholder (cube)
                const subjectGeometry = new THREE.BoxGeometry(1, 2, 1);
                const subjectMaterial = new THREE.MeshLambertMaterial({ color: 0x6677ee });
                const subject = new THREE.Mesh(subjectGeometry, subjectMaterial);
                subject.position.y = 1;
                subject.castShadow = true;
                scene.add(subject);

                // Lighting setup
                updateLighting();

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();

                // Cleanup
                return () => {
                    if (mountRef.current && renderer.domElement) {
                        mountRef.current.removeChild(renderer.domElement);
                    }
                };
            }, []);

            useEffect(() => {
                updateLighting();
                updateCamera();
            }, [sceneConfig]);

            function updateLighting() {
                if (!sceneRef.current) return;

                // Clear existing lights
                const lights = sceneRef.current.children.filter(child => child.type.includes('Light'));
                lights.forEach(light => sceneRef.current.remove(light));

                // Ambient light
                const ambientLight = new THREE.AmbientLight(0x404040, sceneConfig.lighting.ambient || 0.3);
                sceneRef.current.add(ambientLight);

                // Directional light (key light)
                const directionalLight = new THREE.DirectionalLight(0xffffff, sceneConfig.lighting.intensity || 1);
                directionalLight.position.set(
                    sceneConfig.lighting.x || 5,
                    sceneConfig.lighting.y || 10,
                    sceneConfig.lighting.z || 5
                );
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                sceneRef.current.add(directionalLight);

                // Background color based on time of day
                const timeColors = {
                    'dawn': 0x87CEEB,
                    'day': 0x87CEEB,
                    'dusk': 0xFF6347,
                    'night': 0x191970
                };
                sceneRef.current.background = new THREE.Color(timeColors[sceneConfig.lighting.timeOfDay] || 0x202020);
            }

            function updateCamera() {
                if (!cameraRef.current) return;
                
                cameraRef.current.fov = sceneConfig.camera.fov || 50;
                cameraRef.current.updateProjectionMatrix();
            }

            return <div ref={mountRef} style={{ width: '100%', height: '100%' }} />;
        }

        // Scene Controls Component
        function SceneControls({ sceneConfig, onConfigChange }) {
            return (
                <div className="scene-controls">
                    <h4 style={{ marginBottom: '15px', fontSize: '14px' }}>Camera Controls</h4>
                    
                    <div className="control-group">
                        <label>Field of View: {sceneConfig.camera.fov}°</label>
                        <input
                            type="range"
                            min="20"
                            max="120"
                            value={sceneConfig.camera.fov}
                            onChange={(e) => onConfigChange({
                                ...sceneConfig,
                                camera: { ...sceneConfig.camera, fov: parseInt(e.target.value) }
                            })}
                        />
                    </div>

                    <div className="control-group">
                        <label>Shot Type</label>
                        <select
                            value={sceneConfig.camera.shotType}
                            onChange={(e) => onConfigChange({
                                ...sceneConfig,
                                camera: { ...sceneConfig.camera, shotType: e.target.value }
                            })}
                        >
                            <option value="wide">Wide Shot</option>
                            <option value="medium">Medium Shot</option>
                            <option value="close">Close-up</option>
                            <option value="extreme">Extreme Close-up</option>
                        </select>
                    </div>

                    <h4 style={{ marginBottom: '15px', fontSize: '14px', marginTop: '20px' }}>Lighting</h4>
                    
                    <div className="control-group">
                        <label>Intensity: {sceneConfig.lighting.intensity}</label>
                        <input
                            type="range"
                            min="0"
                            max="2"
                            step="0.1"
                            value={sceneConfig.lighting.intensity}
                            onChange={(e) => onConfigChange({
                                ...sceneConfig,
                                lighting: { ...sceneConfig.lighting, intensity: parseFloat(e.target.value) }
                            })}
                        />
                    </div>

                    <div className="control-group">
                        <label>Time of Day</label>
                        <select
                            value={sceneConfig.lighting.timeOfDay}
                            onChange={(e) => onConfigChange({
                                ...sceneConfig,
                                lighting: { ...sceneConfig.lighting, timeOfDay: e.target.value }
                            })}
                        >
                            <option value="dawn">Dawn</option>
                            <option value="day">Day</option>
                            <option value="dusk">Dusk</option>
                            <option value="night">Night</option>
                        </select>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [apiKey, setApiKey] = useState('');
            const [messages, setMessages] = useState([
                {
                    type: 'ai',
                    content: 'Hi! I\'m here to help you create a Veo3 JSON prompt. Use the 3D scene on the right to experiment with camera angles and lighting. Describe your video idea and I\'ll help structure it using the 8-component framework.'
                }
            ]);
            const [inputValue, setInputValue] = useState('');
            const [currentPrompt, setCurrentPrompt] = useState({
                prompt: "",
                caption: "",
                file_name: "video.mp4",
                input_image_urls: [],
                input_ids: []
            });

            const [sceneConfig, setSceneConfig] = useState({
                camera: {
                    fov: 50,
                    x: 0,
                    y: 5,
                    z: 10,
                    shotType: 'medium'
                },
                lighting: {
                    intensity: 1,
                    ambient: 0.3,
                    x: 5,
                    y: 10,
                    z: 5,
                    timeOfDay: 'day'
                }
            });

            const [promptComponents, setPromptComponents] = useState({
                subject: "",
                action: "",
                scene: "",
                style: "cinematic, photorealistic",
                camera: "",
                composition: "",
                ambiance: "",
                audio: ""
            });

            const sendMessage = async () => {
                if (!inputValue.trim()) return;
                
                if (!apiKey.trim()) {
                    alert('Please enter your Mistral API key first.');
                    return;
                }

                const userMessage = { type: 'user', content: inputValue };
                setMessages(prev => [...prev, userMessage]);
                setInputValue('');

                try {
                    const sceneDescription = `Current 3D scene: Camera FOV ${sceneConfig.camera.fov}°, ${sceneConfig.camera.shotType} shot, ${sceneConfig.lighting.timeOfDay} lighting with intensity ${sceneConfig.lighting.intensity}`;
                    
                    const context = `You are an expert Veo3 prompt builder. Help the user create structured JSON prompts using the 8-component framework.

Current scene visualization: ${sceneDescription}

Use this context to inform your suggestions. Ask targeted questions about missing components and provide specific technical guidance.

User message: "${inputValue}"

Respond conversationally and suggest how the 3D scene settings might inform the prompt components.`;

                    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'mistral-large-latest',
                            messages: [
                                { role: 'system', content: context },
                                { role: 'user', content: inputValue }
                            ],
                            temperature: 0.7,
                            max_tokens: 1000
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiResponse = { type: 'ai', content: data.choices[0].message.content };
                    setMessages(prev => [...prev, aiResponse]);

                    // Extract JSON if present
                    const jsonMatch = data.choices[0].message.content.match(/```json\n([\s\S]*?)\n```/);
                    if (jsonMatch) {
                        try {
                            const newPrompt = JSON.parse(jsonMatch[1]);
                            setCurrentPrompt(prev => ({ ...prev, ...newPrompt }));
                        } catch (e) {
                            console.error('Failed to parse JSON:', e);
                        }
                    }

                } catch (error) {
                    const errorMessage = { type: 'ai', content: 'Sorry, there was an error connecting to the AI. Please check your API key and try again.' };
                    setMessages(prev => [...prev, errorMessage]);
                    console.error('Error:', error);
                }
            };

            const copyJSON = () => {
                navigator.clipboard.writeText(JSON.stringify(currentPrompt, null, 2));
            };

            const updatePromptComponent = (component, value) => {
                setPromptComponents(prev => ({ ...prev, [component]: value }));
                
                // Auto-update main prompt when components change
                const newPrompt = Object.values(promptComponents).filter(Boolean).join('. ');
                setCurrentPrompt(prev => ({ ...prev, prompt: newPrompt }));
            };

            return (
                <div className="app-container">
                    {/* Left Sidebar - Prompt Components */}
                    <div className="sidebar">
                        <div className="section-title">API Configuration</div>
                        <input
                            type="password"
                            className="api-key-input"
                            placeholder="Enter Mistral API key"
                            value={apiKey}
                            onChange={(e) => setApiKey(e.target.value)}
                        />

                        <div className="section-title">8-Component Framework</div>
                        
                        {Object.entries(promptComponents).map(([key, value]) => (
                            <div key={key} className="component-input">
                                <label>{key.charAt(0).toUpperCase() + key.slice(1)}</label>
                                <textarea
                                    value={value}
                                    onChange={(e) => updatePromptComponent(key, e.target.value)}
                                    placeholder={`Describe the ${key}...`}
                                />
                            </div>
                        ))}

                        <div className="json-output">
                            {JSON.stringify(currentPrompt, null, 2)}
                        </div>
                        <button className="copy-btn" onClick={copyJSON}>Copy JSON</button>
                    </div>

                    {/* Center - 3D Scene */}
                    <div className="main-scene">
                        <SceneViewer 
                            sceneConfig={sceneConfig} 
                            onSceneUpdate={setSceneConfig}
                        />
                        <SceneControls 
                            sceneConfig={sceneConfig} 
                            onConfigChange={setSceneConfig}
                        />
                        <div className="scene-info">
                            Camera: {sceneConfig.camera.shotType} • FOV: {sceneConfig.camera.fov}°<br/>
                            Lighting: {sceneConfig.lighting.timeOfDay} • Intensity: {sceneConfig.lighting.intensity}
                        </div>
                    </div>

                    {/* Right Panel - AI Chat */}
                    <div className="chat-panel">
                        <div className="chat-header">
                            💬 AI Prompt Assistant
                        </div>
                        <div className="chat-messages">
                            {messages.map((message, index) => (
                                <div key={index} className={`message ${message.type}-message`}>
                                    {message.content}
                                </div>
                            ))}
                        </div>
                        <div className="chat-input-area">
                            <div className="input-container">
                                <input
                                    type="text"
                                    className="chat-input"
                                    placeholder="Describe your video idea..."
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                />
                                <button className="send-btn" onClick={sendMessage}>Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>